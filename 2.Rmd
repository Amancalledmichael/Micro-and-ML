---
title: "R Notebook"
output: html_notebook
---

```{r setup}
library(AER)
library(truncreg)
library(margins)
library(censReg)
library(tidyverse) # for data warangling and filter select etc to manipulate dataset (In this script we only use filter, however the tidyverse is a great package to handle data) 


#R Markdown files automatically set the wd to their directory
#Because of that the working directory should be the same as the directory of this file 
getwd() 

labsupp <- read.csv(file = 'mroz_wool.csv')
head(labsupp)
```

&nbsp;  

# OLS
```{r}
OLS <- lm(hours ~ kidslt6 + kidsge6 + age + educ + nwifeinc + city + exper + expersq, data = labsupp)
summary(OLS)
```

&nbsp;  

# 1)
```{r}
tobit <- tobit(hours ~ kidslt6 + kidsge6 + age + educ + nwifeinc + city + exper + expersq,
               data = labsupp)
summary(tobit)
```

&nbsp;  

# 2)
```{r}
trunc <- truncreg(hours ~ kidslt6 + kidsge6 + age + educ + nwifeinc + city + exper + expersq, data = labsupp)
summary(trunc)

```
&nbsp;  

# 3)
Wages are unobservable for those who do not work. Also, the causality might go the other way round: hours worked can also affect wages (e.g. though a wage premium for long hours, see https://blogs.lse.ac.uk/usappblog/2014/05/28/the-wage-premium-for-working-long-hours-has-helped-lead-to-the-stagnation-of-the-gender-wage-gap/).
The coefficients from the truncated regression can be interpreted as the marginal effects of the respective variable on labor supply for those working. It is negative and statistically significant, i.e. for women who work, additional income from other sources reduces their labor supply (which makes sense). 

&nbsp;  

# 4)
### using censReg
using censReg: The marginal effects differ now, though they are not in the expected order 
```{r}

#running regression with censReg
cr_tobit <- censReg(hours ~ kidslt6 + kidsge6 + age + educ + nwifeinc + city + exper + expersq,
               data = labsupp)

# beta
summary(cr_tobit)[["estimate"]][6,1]

# marginal effect at average 
margEff(cr_tobit)[[5]]

labsupp_working <- labsupp %>% 
  filter(inlf == 1) %>% 
  select(inlf, kidslt6 , kidsge6 , age , educ , nwifeinc , city , exper , expersq) %>% 
  as.tibble()

labsupp_working_means <- labsupp %>% 
  filter(inlf == 1) %>% 
  select(inlf, kidslt6 , kidsge6 , age , educ , nwifeinc , city , exper , expersq) %>% 
  as.tibble() %>% 
  colMeans()

# marginal effect at average for workers
margEff(cr_tobit, labsupp_working_means)[[5]]

```

Calculating the marginal effects at for each observation and then taking the average over all:
```{r}

# calculate the marginal effect for all obs for the given variable var from the model model with data x and subsequently take the average over all 
calc_ape <- function(model, x, var) {
  out <- as.double(length(x[[1]]))
  for (i in 1:length(x[[1]])) {
    out[i] <- margEff(cr_tobit, unlist(x[i,]))[[var]]
    
  }
  mean(out)
}

# average marginal effect for all
calc_ape(cr_tobit, select(labsupp, inlf, kidslt6 , kidsge6 , age , educ , nwifeinc , city , exper , expersq), "nwifeinc")

# avg marginal effect for working
calc_ape(cr_tobit, labsupp_working, "nwifeinc")

```
### before

```{r}
# average marginal effects for all observations in the tobit 
individual_marginal_effects_all <- marginal_effects(tobit)
average_marginal_effects_all <- colMeans(individual_marginal_effects_all)
ame_all_nwifeinc <-  average_marginal_effects_all[5]
ame_all_nwifeinc

# average marginal effects for all
individual_marginal_effects_working <- marginal_effects(tobit, data = labsupp[labsupp$inlf == 1,])
average_marginal_effects_working <- colMeans(individual_marginal_effects_working)
ame_working_nwifeinc <- average_marginal_effects_working[5]
ame_working_nwifeinc
```

```{r}
summary(tobit)
summary(OLS)
```
